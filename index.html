<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>確認フロー（修正版）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .card{background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,.06);padding:20px;margin:14px 0}
    .btn{background:#3b82f6;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer}
    .muted{color:#777}
    input,textarea{border:1px solid #ddd;border-radius:8px}
  </style>

  <!-- Supabase JS (CDN) + robust initializer -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function initSupabaseClient(){
    try{
      if(!window.supabase){ console.warn('[INIT] supabase library missing'); return; }
      const pick=(keys)=>{for(const k of keys){const v=localStorage.getItem(k);if(v&&v.trim())return v.trim();}return null;}
      const url=pick(['project_url','SUPABASE_URL','supabase_url','sb_url']);
      const key=pick(['anon_public_key','SUPABASE_ANON_KEY','supabase_key','anon_key']);
      if(url&&key){ window.sb = window.supabase.createClient(url,key); console.log('[INIT] sb created',{url});}
      else{ console.warn('[INIT] Cannot init sb. url/key not found in localStorage'); }
      window.__reinit_sb__=(u,k)=>{ if(!(u&&k)||!window.supabase) return; window.sb=window.supabase.createClient(u,k); if(window.__refresh_tasks__) window.__refresh_tasks__(); };
    }catch(e){ console.error('[INIT] exception',e); }
  })();
  </script>
</head>
<body>
  <h2>確認フロー（修正版）</h2>

  <!-- 送信フォーム（必要なら既存UIと置換） -->
  <div class="card">
    <div style="display:flex;gap:10px;align-items:center">
      <input id="title" placeholder="タイトル" style="flex:1;padding:10px"/>
      <input id="due" type="datetime-local" style="padding:10px"/>
      <button class="btn" id="send">送信</button>
    </div>
    <div style="margin-top:10px">
      <textarea id="body" placeholder="詳細" rows="4" style="width:100%;padding:10px"></textarea>
    </div>
    <div id="toast" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- 「あなたの未解決タスク」の**専用**差し込み枠 -->
  <div class="card">
    <div style="font-weight:700">あなたの未解決タスク（アプリ側の表示枠）</div>
    <div id="autolist" class="muted" style="margin-top:8px">読み込み中...</div>
  </div>

<script>
const $ = (q)=>document.querySelector(q);
const showToast=(msg)=>{ $('#toast').textContent = msg; };

// --- 未解決タスクを #autolist に描画 ---
window.__refresh_tasks__ = async function(){
  try{
    if(!window.sb){ console.warn('[LIST] sb undefined'); return; }
    const { data: { user } } = await sb.auth.getUser();
    if(!user){ $('#autolist').textContent='未ログインです'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at')
      .eq('created_by', user.id)
      .eq('status','open')
      .order('created_at',{ ascending:false })
      .limit(50);

    if(error){ console.warn('[LIST] error', error); $('#autolist').textContent='読み込みエラー'; return; }

    const fmt = s => (s==null? '' : String(s));
    $('#autolist').innerHTML =
      (data&&data.length) ? data.map(t => `
        <div style="border:1px solid #eee;border-radius:10px;padding:12px;margin:10px 0;background:#fcfdff">
          <div style="font-weight:600;">${fmt(t.title)||'(無題)'}</div>
          <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
          <div style="color:#888;margin-top:6px;font-size:12px;">
            優先度:${fmt(t.priority)||'mid'} ${t.due_at? ' / 期日:'+ new Date(t.due_at).toLocaleString(): ''}
          </div>
        </div>`).join('')
      : '<div class="muted">未解決タスクはありません</div>';

    console.log('[LIST] rendered', data?.length||0);
  }catch(e){ console.error('[LIST] exception', e); }
};

// --- 送信 → DB保存 → リスト更新 ---
$('#send').addEventListener('click', async () => {
  const row = {
    title: $('#title').value.trim(),
    body: $('#body').value.trim() || null,
    priority: 'mid',
    due_at: $('#due').value ? new Date($('#due').value).toISOString() : null,
    status: 'open', tags: [], project: null
  };
  showToast('依頼を送信しました');

  try {
    if (!window.sb) return console.warn('[insert skipped] sb undefined');
    const { data, error } = await sb.from('tasks').insert(row).select();
    if (error) { console.warn('[insert error]', error); showToast('DB保存エラー: '+error.message); }
    else { showToast('DBに保存OK (id:'+(data?.[0]?.id ?? '?')+')'); if(window.__refresh_tasks__) window.__refresh_tasks__(); }
  } catch(e) { console.warn('[insert exception]', e); }
});

// 初回
window.addEventListener('load', () => setTimeout(()=>window.__refresh_tasks__(), 250));
</script>
</body>
</html>
