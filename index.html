<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¢ºèªãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --shadow:0 4px 24px rgba(0,0,0,.06);
      --muted:#777; --line:#e5e7eb; --blue:#3b82f6; --red:#ef4444; --green:#10b981;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:24px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .bar .left{display:flex;gap:8px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .btn.red{background:var(--red)}
    .btn.green{background:var(--green)}
    .btn.sm{padding:6px 10px;font-size:13px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:18px;margin:14px 0}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    input,textarea{border:1px solid var(--line);border-radius:8px;padding:10px;font-size:14px;width:100%}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .list-item{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;background:#fcfdff}
    .list-item .h{font-weight:600}
    .small{font-size:12px;color:#888;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .pill{font-size:12px;background:#eef2ff;color:#3741a0;border-radius:999px;padding:3px 10px;margin-left:8px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 220px} }
    dialog{border:none;border-radius:12px;box-shadow:var(--shadow);padding:18px;max-width:560px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function initSupabaseClient(){
    try{
      if(!window.supabase){ console.warn('[INIT] supabase library missing'); return; }
      const pick=(keys)=>{for(const k of keys){const v=localStorage.getItem(k);if(v&&v.trim())return v.trim();}return null;}
      const url=pick(['project_url','SUPABASE_URL','supabase_url','sb_url']);
      const key=pick(['anon_public_key','SUPABASE_ANON_KEY','supabase_key','anon_key']);
      if(url&&key){ window.sb = window.supabase.createClient(url,key); console.log('[INIT] sb created',{url});}
      else{ console.warn('[INIT] Cannot init sb. url/key not found in localStorage'); }
      window.__reinit_sb__=(u,k)=>{ if(!(u&&k)||!window.supabase) return; window.sb=window.supabase.createClient(u,k);
        if(window.__refresh_open__) window.__refresh_open__();
        if(window.__refresh_returned__) window.__refresh_returned__();
        if(window.__apply_role__) window.__apply_role__(); };
    }catch(e){ console.error('[INIT] exception',e); }
  })();
  </script>
</head>
<body>

  <div class="bar">
    <div class="left">
      <button class="btn ghost" id="openSettings">âš™ è¨­å®š</button>
      <span id="sessionState" class="muted">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
      <span id="roleBadge" class="pill" style="display:none"></span>
    </div>
    <div class="left">
      <button class="btn ghost" id="login">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn ghost" id="logout">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¾é ¼è€…UIï¼‰ -->
  <div class="card" id="requestCard">
    <div class="title">ä¾é ¼ã‚’é€ä¿¡</div>
    <div class="grid">
      <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
      <input id="due" type="datetime-local" />
    </div>
    <div class="row" style="margin-top:10px">
      <textarea id="body" rows="4" placeholder="è©³ç´°"></textarea>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div id="toast" class="muted"></div>
      <button id="send" class="btn">é€ä¿¡</button>
    </div>
  </div>

  <!-- ä¾é ¼è€…ï¼šå·®ã—æˆ»ã—ï¼ˆè¦å¯¾å¿œï¼‰ -->
  <div class="card" id="returnedCard">
    <div class="title">å·®ã—æˆ»ã—ï¼ˆè¦å¯¾å¿œï¼‰</div>
    <div id="returnedList" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- ä¾é ¼è€…ï¼šæœªè§£æ±º -->
  <div class="card" id="requestListCard">
    <div class="title">ã‚ãªãŸã®æœªè§£æ±ºã‚¿ã‚¹ã‚¯ï¼ˆã‚¢ãƒ—ãƒªæ ï¼‰</div>
    <div id="autolist" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- æ‰¿èªè€…ï¼šæ‰¿èªå¾…ã¡ -->
  <div class="card" id="approverCard" style="display:none">
    <div class="title">æ‰¿èªå¾…ã¡ã‚¿ã‚¹ã‚¯ï¼ˆå›šäººPæ ï¼‰</div>
    <div id="approveList" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- æ‰¿èªè€…ï¼šæ‰¿èªæ¸ˆï¼ˆå±¥æ­´ï¼‰ -->
  <div class="card" id="approvedHistoryCard" style="display:none">
    <div class="title">æ‰¿èªæ¸ˆï¼ˆå±¥æ­´ï¼‰</div>
    <div id="approvedList" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="settings">
    <div class="title">åˆæœŸè¨­å®šï¼ˆSupabaseï¼‰</div>
    <div style="display:grid;gap:8px;margin-top:8px">
      <label>Project URL <input id="set_url" placeholder="https://xxxxx.supabase.co" /></label>
      <label>anon public key <textarea id="set_key" rows="3" placeholder="anon public key ã‚’è²¼ã‚Šä»˜ã‘"></textarea></label>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button id="saveSettings" class="btn">ä¿å­˜ã—ã¦å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>
  </dialog>

<script>
const $ = (q)=>document.querySelector(q);
const showToast=(msg)=>{ $('#toast').textContent = msg; };
const fmt = s => (s==null? '' : String(s));
const fmtDate = (v)=> v ? new Date(v).toLocaleString() : '';

/* è¨­å®š */
$('#openSettings').onclick = () => {
  $('#set_url').value = localStorage.getItem('project_url') || '';
  $('#set_key').value = localStorage.getItem('anon_public_key') || '';
  $('#settings').showModal();
};
$('#saveSettings').onclick = () => {
  localStorage.setItem('project_url', $('#set_url').value.trim());
  localStorage.setItem('anon_public_key', $('#set_key').value.trim());
  if (window.__reinit_sb__) window.__reinit_sb__($('#set_url').value.trim(), $('#set_key').value.trim());
  $('#settings').close(); location.reload();
};

/* èªè¨¼ */
async function refreshSessionLabel(){
  if(!window.sb){ $('#sessionState').textContent='è¨­å®šæœªå®Œäº†'; return; }
  const { data:{ user } } = await sb.auth.getUser();
  $('#sessionState').textContent = user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}` : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
}
$('#login').onclick = async () => {
  if(!window.sb){ alert('å…ˆã«è¨­å®šã‹ã‚‰ URL/Key ã‚’ä¿å­˜ã—ã¦ãã ã•ã„'); return; }
  const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'); const password = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
  if(!email || !password) return;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š' + error.message); return; }
  await refreshSessionLabel(); if(window.__apply_role__) window.__apply_role__();
};
$('#logout').onclick = async () => {
  if(window.sb){ await sb.auth.signOut(); await refreshSessionLabel(); if(window.__apply_role__) window.__apply_role__(); }
};

/* profiles å–å¾—/ä½œæˆï¼ˆrole: requester / approver / å›šäººPï¼‰ */
async function getOrCreateProfile() {
  const { data:{ user } } = await sb.auth.getUser();
  if(!user) return null;
  let { data: prof, error } = await sb.from('profiles').select('id,name,role').eq('id', user.id).single();
  if(error || !prof){
    const payload = { id: user.id, name: user.email || 'user', role: 'requester' };
    const { data: inserted, error: ierr } = await sb.from('profiles').insert(payload).select().single();
    if(ierr) { console.warn('create profile error', ierr); return null; }
    prof = inserted;
  }
  return prof;
}

/* ä¾é ¼è€…ï¼šæœªè§£æ±ºï¼ˆopenï¼‰ */
window.__refresh_open__ = async function(){
  try{
    if(!window.sb){ $('#autolist').textContent='è¨­å®šæœªå®Œäº†'; return; }
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('#autolist').textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at,nudge_count,last_nudged_at')
      .eq('created_by', user.id).eq('status','open')
      .order('created_at',{ ascending:false }).limit(50);

    if(error){ console.warn('[OPEN] error', error); $('#autolist').textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return; }

    $('#autolist').innerHTML =
      (data&&data.length)
        ? data.map(t => `
            <div class="list-item">
              <div class="h">${fmt(t.title)||'(ç„¡é¡Œ)'}</div>
              <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
              <div class="small">å„ªå…ˆåº¦:${fmt(t.priority)||'mid'}${t.due_at?' / æœŸæ—¥:'+ fmtDate(t.due_at):''}
                ${t.nudge_count? ' / æ€¥ã’:'+t.nudge_count+'å›':''}
              </div>
              <div class="actions">
                <button class="btn ghost sm action" data-action="nudge" data-id="${t.id}" data-count="${t.nudge_count||0}">æ€¥ã’ï¼ˆé€šçŸ¥ï¼‰</button>
                <button class="btn ghost sm action" data-action="done" data-id="${t.id}">è‡ªåˆ†ã§å®Œäº†</button>
              </div>
            </div>`).join('')
        : '<div class="muted">æœªè§£æ±ºã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  }catch(e){ console.error('[OPEN] exception', e); }
};

/* ä¾é ¼è€…ï¼šå·®ã—æˆ»ã—ï¼ˆreturnedï¼‰ */
window.__refresh_returned__ = async function(){
  try{
    if(!window.sb){ $('#returnedList').textContent='è¨­å®šæœªå®Œäº†'; return; }
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('#returnedList').textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at')
      .eq('created_by', user.id).eq('status','returned')
      .order('created_at',{ ascending:false }).limit(50);

    if(error){ console.warn('[RET] error', error); $('#returnedList').textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return; }

    $('#returnedList').innerHTML =
      (data&&data.length)
        ? data.map(t => `
            <div class="list-item">
              <div class="h">${fmt(t.title)||'(ç„¡é¡Œ)'}</div>
              <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
              <div class="small">å„ªå…ˆåº¦:${fmt(t.priority)||'mid'}${t.due_at?' / æœŸæ—¥:'+ fmtDate(t.due_at):''}</div>
              <div class="actions">
                <button class="btn green sm action" data-action="reopen" data-id="${t.id}">å†ç¢ºèªä¾é ¼</button>
                <button class="btn ghost sm action" data-action="done" data-id="${t.id}">å®Œäº†</button>
              </div>
            </div>`).join('')
        : '<div class="muted">å·®ã—æˆ»ã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  }catch(e){ console.error('[RET] exception', e); }
};

/* æ‰¿èªè€…ï¼šæ‰¿èªå¾…ã¡ï¼ˆopenï¼‰ï¼†å±¥æ­´ï¼ˆapprovedï¼‰ */
async function refreshApproveList() {
  const box = $('#approveList'); box.textContent='èª­ã¿è¾¼ã¿ä¸­...';
  const { data:{ user } } = await sb.auth.getUser(); if(!user){ box.textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'; return; }
  const { data, error } = await sb.from('tasks')
    .select('id,title,body,priority,due_at,status,created_by,created_at')
    .neq('created_by', user.id).eq('status','open')
    .order('created_at', { ascending:false }).limit(50);
  if(error){ console.warn('[APPROVE] error', error); box.textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return; }
  box.innerHTML = (data&&data.length)
    ? data.map(t => `
        <div class="list-item">
          <div class="h">${fmt(t.title)||'(ç„¡é¡Œ)'}</div>
          <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
          <div class="small">å„ªå…ˆåº¦:${fmt(t.priority)||'mid'} ${t.due_at?' / æœŸæ—¥:'+fmtDate(t.due_at):''}</div>
          <div class="actions">
            <button class="btn green sm action" data-action="approve" data-id="${t.id}">ç¢ºèª</button>
            <button class="btn ghost sm action" data-action="return" data-id="${t.id}">å·®ã—æˆ»ã—</button>
            <button class="btn ghost sm action" data-action="done" data-id="${t.id}">å®Œäº†</button>
          </div>
        </div>`).join('')
    : '<div class="muted">æ‰¿èªå¾…ã¡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}
async function refreshApprovedHistory() {
  const box = $('#approvedList'); box.textContent='èª­ã¿è¾¼ã¿ä¸­...';
  const { data, error } = await sb.from('tasks')
    .select('id,title,updated_at,created_at').eq('status','approved')
    .order('updated_at', { ascending:false }).limit(30);
  if(error){ console.warn('[HIST] error', error); box.textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return; }
  box.innerHTML = (data&&data.length)
    ? data.map(t => `<div class="list-item"><div class="h">${fmt(t.title)||'(ç„¡é¡Œ)'}</div>
        <div class="small">æ‰¿èªæ—¥æ™‚: ${fmtDate(t.updated_at)||fmtDate(t.created_at)||''}</div></div>`).join('')
    : '<div class="muted">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
}

/* å½¹å‰²åˆ‡æ›¿ */
window.__apply_role__ = async function(){
  const prof = await getOrCreateProfile();
  const role = prof?.role || 'requester';
  const isApprover = (role === 'approver' || role === 'å›šäººP');

  const badge = $('#roleBadge'); badge.style.display='inline-block';
  badge.textContent = isApprover ? 'æ‰¿èªè€…ï¼ˆå›šäººPï¼‰' : 'ä¾é ¼è€…';

  $('#requestCard').style.display      = isApprover ? 'none' : '';
  $('#requestListCard').style.display  = isApprover ? 'none' : '';
  $('#returnedCard').style.display     = isApprover ? 'none' : '';
  $('#approverCard').style.display     = isApprover ? 'block' : 'none';
  $('#approvedHistoryCard').style.display = isApprover ? 'block' : 'none';

  if(isApprover){ await refreshApproveList(); await refreshApprovedHistory(); }
  else { await window.__refresh_returned__(); await window.__refresh_open__(); }
};

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰ */
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.action'); if(!btn) return;
  const id = +btn.dataset.id; const act = btn.dataset.action;

  try{
    if(act==='nudge'){
      const count = +(btn.dataset.count||0)+1;
      const { error } = await sb.from('tasks').update({
        nudge_count: count, last_nudged_at: new Date().toISOString()
      }).eq('id', id);
      if(error) return alert('æ€¥ã’ã‚¨ãƒ©ãƒ¼: '+error.message);
      await window.__refresh_open__();

    }else if(act==='approve'){
      const { error } = await sb.from('tasks').update({ status:'approved' }).eq('id', id);
      if(error) return alert('æ‰¿èªã‚¨ãƒ©ãƒ¼: '+error.message);
      await refreshApproveList(); await refreshApprovedHistory();

    }else if(act==='return'){
      const { error } = await sb.from('tasks').update({ status:'returned' }).eq('id', id);
      if(error) return alert('å·®ã—æˆ»ã—ã‚¨ãƒ©ãƒ¼: '+error.message);
      await refreshApproveList();             // æ‰¿èªå¾…ã¡ã‹ã‚‰æ¶ˆãˆã‚‹
      await window.__refresh_returned__();    // ä¾é ¼è€…å´ã®å·®ã—æˆ»ã—ã«å…¥ã‚‹ï¼ˆæ¬¡å›è¡¨ç¤ºæ™‚ï¼‰

    }else if(act==='reopen'){
      const { error } = await sb.from('tasks').update({ status:'open' }).eq('id', id);
      if(error) return alert('å†ç¢ºèªä¾é ¼ã‚¨ãƒ©ãƒ¼: '+error.message);
      await window.__refresh_returned__(); await window.__refresh_open__();

    }else if(act==='done'){
      const { error } = await sb.from('tasks').update({ status:'done' }).eq('id', id);
      if(error) return alert('å®Œäº†ã‚¨ãƒ©ãƒ¼: '+error.message);
      // ä¸¡ç”»é¢ã‹ã‚‰æ¶ˆã™
      await window.__refresh_returned__().catch(()=>{});
      await window.__refresh_open__().catch(()=>{});
      await refreshApproveList().catch(()=>{});
    }
  }catch(err){ alert('å‡¦ç†ä¸­ã«ä¾‹å¤–: '+err); }
});

/* é€ä¿¡ï¼ˆä¿å­˜â†’ãƒªã‚¹ãƒˆæ›´æ–°ï¼‰ */
let sending=false;
$('#send').onclick = async () => {
  if(sending) return;
  sending = true; $('#send').disabled=true; setTimeout(()=>{$('#send').disabled=false;sending=false;},1200);

  const row = {
    title: $('#title').value.trim(),
    body: $('#body').value.trim() || null,
    priority: 'mid',
    due_at: $('#due').value ? new Date($('#due').value).toISOString() : null,
    status: 'open', tags: [], project: null
  };
  showToast('ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ');

  try{
    if(!window.sb){ showToast('è¨­å®šæœªå®Œäº†'); return; }
    const { data, error } = await sb.from('tasks').insert(row).select();
    if(error){ console.warn('[insert error]', error); showToast('DBä¿å­˜ã‚¨ãƒ©ãƒ¼: '+error.message); }
    else { showToast('DBã«ä¿å­˜OK (id:'+(data?.[0]?.id ?? '?')+')');
      await window.__refresh_open__(); }
  }catch(e){ console.warn('[insert exception]', e); showToast('ä¾‹å¤–: '+e); }
};

/* åˆæœŸè¡¨ç¤º */
window.addEventListener('load', async () => {
  await refreshSessionLabel();
  if(window.__apply_role__) await window.__apply_role__();
});
</script>
</body>
</html>
