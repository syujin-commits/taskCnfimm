<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>確認フロー（修正版）</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --shadow:0 4px 24px rgba(0,0,0,.06);
      --muted:#777; --line:#e5e7eb; --blue:#3b82f6; --red:#ef4444; --green:#10b981;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:24px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .bar .left{display:flex;gap:8px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .btn.red{background:var(--red)}
    .btn.green{background:var(--green)}
    .btn.sm{padding:6px 10px;font-size:13px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:18px;margin:14px 0}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    input,textarea{border:1px solid var(--line);border-radius:8px;padding:10px;font-size:14px;width:100%}
    .row{display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .list-item{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;background:#fcfdff}
    .list-item .h{font-weight:600}
    .small{font-size:12px;color:#888;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .pill{font-size:12px;background:#eef2ff;color:#3741a0;border-radius:999px;padding:3px 10px;margin-left:8px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 220px} }
    dialog{border:none;border-radius:12px;box-shadow:var(--shadow);padding:18px;max-width:560px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function initSupabaseClient(){
    try{
      if(!window.supabase){ console.warn('[INIT] supabase library missing'); return; }
      const pick=(keys)=>{for(const k of keys){const v=localStorage.getItem(k);if(v&&v.trim())return v.trim();}return null;}
      const url=pick(['project_url','SUPABASE_URL','supabase_url','sb_url']);
      const key=pick(['anon_public_key','SUPABASE_ANON_KEY','supabase_key','anon_key']);
      if(url&&key){ window.sb = window.supabase.createClient(url,key); console.log('[INIT] sb created',{url});}
      else{ console.warn('[INIT] Cannot init sb. url/key not found in localStorage'); }
      window.__reinit_sb__=(u,k)=>{ if(!(u&&k)||!window.supabase) return; window.sb=window.supabase.createClient(u,k);
        if(window.__refresh_open__) window.__refresh_open__();
        if(window.__refresh_returned__) window.__refresh_returned__();
        if(window.__apply_role__) window.__apply_role__(); };
    }catch(e){ console.error('[INIT] exception',e); }
  })();
  </script>
</head>
<body>

  <div class="bar">
    <div class="left">
      <button class="btn ghost" id="openSettings">⚙ 設定</button>
      <span id="sessionState" class="muted">未ログイン</span>
      <span id="roleBadge" class="pill" style="display:none"></span>
    </div>
    <div class="left">
      <button class="btn ghost" id="login">🔐 ログイン</button>
      <button class="btn ghost" id="logout">🚪 ログアウト</button>
    </div>
  </div>

  <!-- 依頼フォーム（依頼者UI） -->
  <div class="card" id="requestCard">
    <div class="title">依頼を送信</div>
    <div class="grid">
      <input id="title" placeholder="タイトル" />
      <input id="due" type="datetime-local" />
    </div>
    <div class="row" style="margin-top:10px">
      <textarea id="body" rows="4" placeholder="詳細"></textarea>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div id="toast" class="muted"></div>
      <button id="send" class="btn">送信</button>
    </div>
  </div>

  <!-- 依頼者：差し戻し（要対応） -->
  <div class="card" id="returnedCard">
    <div class="title">差し戻し（要対応）</div>
    <div id="returnedList" class="muted">読み込み中...</div>
  </div>

  <!-- 依頼者：未解決 -->
  <div class="card" id="requestListCard">
    <div class="title">あなたの未解決タスク（アプリ枠）</div>
    <div id="autolist" class="muted">読み込み中...</div>
  </div>

  <!-- 承認者：承認待ち -->
  <div class="card" id="approverCard" style="display:none">
    <div class="title">承認待ちタスク（囚人P枠）</div>
    <div id="approveList" class="muted">読み込み中...</div>
  </div>

  <!-- 承認者：承認済（履歴） -->
  <div class="card" id="approvedHistoryCard" style="display:none">
    <div class="title">承認済（履歴）</div>
    <div id="approvedList" class="muted">読み込み中...</div>
  </div>

  <!-- 設定ダイアログ -->
  <dialog id="settings">
    <div class="title">初期設定（Supabase）</div>
    <div style="display:grid;gap:8px;margin-top:8px">
      <label>Project URL <input id="set_url" placeholder="https://xxxxx.supabase.co" /></label>
      <label>anon public key <textarea id="set_key" rows="3" placeholder="anon public key を貼り付け"></textarea></label>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button id="saveSettings" class="btn">保存して再読み込み</button>
      </div>
    </div>
  </dialog>

<script>
const $ = (q)=>document.querySelector(q);
const showToast=(msg)=>{ $('#toast').textContent = msg; };
const fmt = s => (s==null? '' : String(s));
const fmtDate = (v)=> v ? new Date(v).toLocaleString() : '';

/* 設定 */
$('#openSettings').onclick = () => {
  $('#set_url').value = localStorage.getItem('project_url') || '';
  $('#set_key').value = localStorage.getItem('anon_public_key') || '';
  $('#settings').showModal();
};
$('#saveSettings').onclick = () => {
  localStorage.setItem('project_url', $('#set_url').value.trim());
  localStorage.setItem('anon_public_key', $('#set_key').value.trim());
  if (window.__reinit_sb__) window.__reinit_sb__($('#set_url').value.trim(), $('#set_key').value.trim());
  $('#settings').close(); location.reload();
};

/* 認証 */
async function refreshSessionLabel(){
  if(!window.sb){ $('#sessionState').textContent='設定未完了'; return; }
  const { data:{ user } } = await sb.auth.getUser();
  $('#sessionState').textContent = user ? `ログイン中：${user.email}` : '未ログイン';
}
$('#login').onclick = async () => {
  if(!window.sb){ alert('先に設定から URL/Key を保存してください'); return; }
  const email = prompt('メールアドレス'); const password = prompt('パスワード');
  if(!email || !password) return;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ alert('ログイン失敗：' + error.message); return; }
  await refreshSessionLabel(); if(window.__apply_role__) window.__apply_role__();
};
$('#logout').onclick = async () => {
  if(window.sb){ await sb.auth.signOut(); await refreshSessionLabel(); if(window.__apply_role__) window.__apply_role__(); }
};

/* profiles 取得/作成（role: requester / approver / 囚人P） */
async function getOrCreateProfile() {
  const { data:{ user } } = await sb.auth.getUser();
  if(!user) return null;
  let { data: prof, error } = await sb.from('profiles').select('id,name,role').eq('id', user.id).single();
  if(error || !prof){
    const payload = { id: user.id, name: user.email || 'user', role: 'requester' };
    const { data: inserted, error: ierr } = await sb.from('profiles').insert(payload).select().single();
    if(ierr) { console.warn('create profile error', ierr); return null; }
    prof = inserted;
  }
  return prof;
}

/* 依頼者：未解決（open） */
window.__refresh_open__ = async function(){
  try{
    if(!window.sb){ $('#autolist').textContent='設定未完了'; return; }
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('#autolist').textContent='未ログインです'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at,nudge_count,last_nudged_at')
      .eq('created_by', user.id).eq('status','open')
      .order('created_at',{ ascending:false }).limit(50);

    if(error){ console.warn('[OPEN] error', error); $('#autolist').textContent='読み込みエラー'; return; }

    $('#autolist').innerHTML =
      (data&&data.length)
        ? data.map(t => `
            <div class="list-item">
              <div class="h">${fmt(t.title)||'(無題)'}</div>
              <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
              <div class="small">優先度:${fmt(t.priority)||'mid'}${t.due_at?' / 期日:'+ fmtDate(t.due_at):''}
                ${t.nudge_count? ' / 急げ:'+t.nudge_count+'回':''}
              </div>
              <div class="actions">
                <button class="btn ghost sm action" data-action="nudge" data-id="${t.id}" data-count="${t.nudge_count||0}">急げ（通知）</button>
                <button class="btn ghost sm action" data-action="done" data-id="${t.id}">自分で完了</button>
              </div>
            </div>`).join('')
        : '<div class="muted">未解決タスクはありません</div>';
  }catch(e){ console.error('[OPEN] exception', e); }
};

/* 依頼者：差し戻し（returned） */
window.__refresh_returned__ = async function(){
  try{
    if(!window.sb){ $('#returnedList').textContent='設定未完了'; return; }
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('#returnedList').textContent='未ログインです'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at')
      .eq('created_by', user.id).eq('status','returned')
      .order('created_at',{ ascending:false }).limit(50);

    if(error){ console.warn('[RET] error', error); $('#returnedList').textContent='読み込みエラー'; return; }

    $('#returnedList').innerHTML =
      (data&&data.length)
        ? data.map(t => `
            <div class="list-item">
              <div class="h">${fmt(t.title)||'(無題)'}</div>
              <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
              <div class="small">優先度:${fmt(t.priority)||'mid'}${t.due_at?' / 期日:'+ fmtDate(t.due_at):''}</div>
              <div class="actions">
                <button class="btn green sm action" data-action="reopen" data-id="${t.id}">再確認依頼</button>
                <button class="btn ghost sm action" data-action="done" data-id="${t.id}">完了</button>
              </div>
            </div>`).join('')
        : '<div class="muted">差し戻しはありません</div>';
  }catch(e){ console.error('[RET] exception', e); }
};

/* 承認者：承認待ち（open）＆履歴（approved） */
async function refreshApproveList() {
  const box = $('#approveList'); box.textContent='読み込み中...';
  const { data:{ user } } = await sb.auth.getUser(); if(!user){ box.textContent='未ログインです'; return; }
  const { data, error } = await sb.from('tasks')
    .select('id,title,body,priority,due_at,status,created_by,created_at')
    .neq('created_by', user.id).eq('status','open')
    .order('created_at', { ascending:false }).limit(50);
  if(error){ console.warn('[APPROVE] error', error); box.textContent='読み込みエラー'; return; }
  box.innerHTML = (data&&data.length)
    ? data.map(t => `
        <div class="list-item">
          <div class="h">${fmt(t.title)||'(無題)'}</div>
          <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
          <div class="small">優先度:${fmt(t.priority)||'mid'} ${t.due_at?' / 期日:'+fmtDate(t.due_at):''}</div>
          <div class="actions">
            <button class="btn green sm action" data-action="approve" data-id="${t.id}">確認</button>
            <button class="btn ghost sm action" data-action="return" data-id="${t.id}">差し戻し</button>
            <button class="btn ghost sm action" data-action="done" data-id="${t.id}">完了</button>
          </div>
        </div>`).join('')
    : '<div class="muted">承認待ちはありません</div>';
}
async function refreshApprovedHistory() {
  const box = $('#approvedList'); box.textContent='読み込み中...';
  const { data, error } = await sb.from('tasks')
    .select('id,title,updated_at,created_at').eq('status','approved')
    .order('updated_at', { ascending:false }).limit(30);
  if(error){ console.warn('[HIST] error', error); box.textContent='読み込みエラー'; return; }
  box.innerHTML = (data&&data.length)
    ? data.map(t => `<div class="list-item"><div class="h">${fmt(t.title)||'(無題)'}</div>
        <div class="small">承認日時: ${fmtDate(t.updated_at)||fmtDate(t.created_at)||''}</div></div>`).join('')
    : '<div class="muted">履歴はありません</div>';
}

/* 役割切替 */
window.__apply_role__ = async function(){
  const prof = await getOrCreateProfile();
  const role = prof?.role || 'requester';
  const isApprover = (role === 'approver' || role === '囚人P');

  const badge = $('#roleBadge'); badge.style.display='inline-block';
  badge.textContent = isApprover ? '承認者（囚人P）' : '依頼者';

  $('#requestCard').style.display      = isApprover ? 'none' : '';
  $('#requestListCard').style.display  = isApprover ? 'none' : '';
  $('#returnedCard').style.display     = isApprover ? 'none' : '';
  $('#approverCard').style.display     = isApprover ? 'block' : 'none';
  $('#approvedHistoryCard').style.display = isApprover ? 'block' : 'none';

  if(isApprover){ await refreshApproveList(); await refreshApprovedHistory(); }
  else { await window.__refresh_returned__(); await window.__refresh_open__(); }
};

/* アクション（イベント委譲） */
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.action'); if(!btn) return;
  const id = +btn.dataset.id; const act = btn.dataset.action;

  try{
    if(act==='nudge'){
      const count = +(btn.dataset.count||0)+1;
      const { error } = await sb.from('tasks').update({
        nudge_count: count, last_nudged_at: new Date().toISOString()
      }).eq('id', id);
      if(error) return alert('急げエラー: '+error.message);
      await window.__refresh_open__();

    }else if(act==='approve'){
      const { error } = await sb.from('tasks').update({ status:'approved' }).eq('id', id);
      if(error) return alert('承認エラー: '+error.message);
      await refreshApproveList(); await refreshApprovedHistory();

    }else if(act==='return'){
      const { error } = await sb.from('tasks').update({ status:'returned' }).eq('id', id);
      if(error) return alert('差し戻しエラー: '+error.message);
      await refreshApproveList();             // 承認待ちから消える
      await window.__refresh_returned__();    // 依頼者側の差し戻しに入る（次回表示時）

    }else if(act==='reopen'){
      const { error } = await sb.from('tasks').update({ status:'open' }).eq('id', id);
      if(error) return alert('再確認依頼エラー: '+error.message);
      await window.__refresh_returned__(); await window.__refresh_open__();

    }else if(act==='done'){
      const { error } = await sb.from('tasks').update({ status:'done' }).eq('id', id);
      if(error) return alert('完了エラー: '+error.message);
      // 両画面から消す
      await window.__refresh_returned__().catch(()=>{});
      await window.__refresh_open__().catch(()=>{});
      await refreshApproveList().catch(()=>{});
    }
  }catch(err){ alert('処理中に例外: '+err); }
});

/* 送信（保存→リスト更新） */
let sending=false;
$('#send').onclick = async () => {
  if(sending) return;
  sending = true; $('#send').disabled=true; setTimeout(()=>{$('#send').disabled=false;sending=false;},1200);

  const row = {
    title: $('#title').value.trim(),
    body: $('#body').value.trim() || null,
    priority: 'mid',
    due_at: $('#due').value ? new Date($('#due').value).toISOString() : null,
    status: 'open', tags: [], project: null
  };
  showToast('依頼を送信しました');

  try{
    if(!window.sb){ showToast('設定未完了'); return; }
    const { data, error } = await sb.from('tasks').insert(row).select();
    if(error){ console.warn('[insert error]', error); showToast('DB保存エラー: '+error.message); }
    else { showToast('DBに保存OK (id:'+(data?.[0]?.id ?? '?')+')');
      await window.__refresh_open__(); }
  }catch(e){ console.warn('[insert exception]', e); showToast('例外: '+e); }
};

/* 初期表示 */
window.addEventListener('load', async () => {
  await refreshSessionLabel();
  if(window.__apply_role__) await window.__apply_role__();
});
</script>
</body>
</html>
