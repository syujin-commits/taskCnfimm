<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¢ºèªãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --shadow:0 4px 24px rgba(0,0,0,.06); --muted:#777; --line:#e5e7eb; --blue:#3b82f6;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;background:var(--bg);margin:0;padding:24px}
    .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .bar .left{display:flex;gap:8px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:18px;margin:14px 0}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    input,textarea{border:1px solid var(--line);border-radius:8px;padding:10px;font-size:14px}
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .list-item{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0;background:#fcfdff}
    .list-item .h{font-weight:600}
    .small{font-size:12px;color:#888;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
    dialog{border:none;border-radius:12px;box-shadow:var(--shadow);padding:18px;max-width:560px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.25)}
  </style>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // -------- Supabase åˆæœŸåŒ–ï¼ˆlocalStorage â†’ sb ã‚’ç”Ÿæˆï¼‰ --------
  (function initSupabaseClient(){
    try{
      if(!window.supabase){ console.warn('[INIT] supabase library missing'); return; }
      const pick=(keys)=>{for(const k of keys){const v=localStorage.getItem(k);if(v&&v.trim())return v.trim();}return null;}
      const url=pick(['project_url','SUPABASE_URL','supabase_url','sb_url']);
      const key=pick(['anon_public_key','SUPABASE_ANON_KEY','supabase_key','anon_key']);
      if(url&&key){ window.sb = window.supabase.createClient(url,key); console.log('[INIT] sb created',{url});}
      else{ console.warn('[INIT] Cannot init sb. url/key not found in localStorage'); }
      window.__reinit_sb__=(u,k)=>{ if(!(u&&k)||!window.supabase) return; window.sb=window.supabase.createClient(u,k); if(window.__refresh_tasks__) window.__refresh_tasks__(); };
    }catch(e){ console.error('[INIT] exception',e); }
  })();
  </script>
</head>
<body>

  <!-- ä¸Šéƒ¨ãƒãƒ¼ï¼šè¨­å®šãƒ»èªè¨¼ -->
  <div class="bar">
    <div class="left">
      <button class="btn ghost" id="openSettings">âš™ è¨­å®š</button>
      <span id="sessionState" class="muted">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    </div>
    <div class="left">
      <button class="btn ghost" id="login">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn ghost" id="logout">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <div class="title">ä¾é ¼ã‚’é€ä¿¡</div>
    <div class="grid">
      <input id="title" class="grow" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
      <input id="due" type="datetime-local" />
    </div>
    <div class="row" style="margin-top:10px">
      <textarea id="body" class="grow" rows="4" placeholder="è©³ç´°"></textarea>
    </div>
    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div id="toast" class="muted"></div>
      <button id="send" class="btn">é€ä¿¡</button>
    </div>
  </div>

  <!-- æœªè§£æ±ºã‚¿ã‚¹ã‚¯è¡¨ç¤ºæ ï¼ˆã‚¢ãƒ—ãƒªå´ã§å®Œå…¨ç®¡ç†ï¼‰ -->
  <div class="card">
    <div class="title">ã‚ãªãŸã®æœªè§£æ±ºã‚¿ã‚¹ã‚¯ï¼ˆã‚¢ãƒ—ãƒªæ ï¼‰</div>
    <div id="autolist" class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="settings">
    <div class="title">åˆæœŸè¨­å®šï¼ˆSupabaseï¼‰</div>
    <div style="display:grid;gap:8px;margin-top:8px">
      <label>Project URL
        <input id="set_url" placeholder="https://xxxxx.supabase.co" />
      </label>
      <label>anon public key
        <textarea id="set_key" rows="3" placeholder="anon public key ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
      </label>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button id="saveSettings" class="btn">ä¿å­˜ã—ã¦å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>
  </dialog>

<script>
const $ = (q)=>document.querySelector(q);
const showToast=(msg)=>{ $('#toast').textContent = msg; };

// ---------- è¨­å®šï¼ˆURL/Keyï¼‰ ----------
$('#openSettings').onclick = () => {
  $('#set_url').value = localStorage.getItem('project_url') || '';
  $('#set_key').value = localStorage.getItem('anon_public_key') || '';
  $('#settings').showModal();
};
$('#saveSettings').onclick = () => {
  const url = $('#set_url').value.trim();
  const key = $('#set_key').value.trim();
  localStorage.setItem('project_url', url);
  localStorage.setItem('anon_public_key', key);
  if (window.__reinit_sb__) window.__reinit_sb__(url,key);
  $('#settings').close();
  location.reload();
};

// ---------- èªè¨¼ ----------
async function refreshSessionLabel(){
  if(!window.sb){ $('#sessionState').textContent='è¨­å®šæœªå®Œäº†'; return; }
  const { data:{ user } } = await sb.auth.getUser();
  $('#sessionState').textContent = user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}` : 'æœªãƒ­ã‚°ã‚¤ãƒ³';
}
$('#login').onclick = async () => {
  if(!window.sb){ alert('å…ˆã«è¨­å®šã‹ã‚‰ URL/Key ã‚’ä¿å­˜ã—ã¦ãã ã•ã„'); return; }
  const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹');
  const password = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰');
  if(!email || !password) return;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š' + error.message); return; }
  await refreshSessionLabel(); if(window.__refresh_tasks__) window.__refresh_tasks__();
};
$('#logout').onclick = async () => { if(window.sb){ await sb.auth.signOut(); await refreshSessionLabel(); if(window.__refresh_tasks__) window.__refresh_tasks__(); } };

// ---------- ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼ˆæœªè§£æ±ºï¼‰ ----------
window.__refresh_tasks__ = async function(){
  try{
    if(!window.sb){ $('#autolist').textContent='è¨­å®šæœªå®Œäº†'; return; }
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('#autolist').textContent='æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'; return; }

    const { data, error } = await sb.from('tasks')
      .select('id,title,body,priority,due_at,status,created_at')
      .eq('created_by', user.id)          // è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ã ã‘
      .eq('status','open')                // æœªè§£æ±ºã®ã¿
      .order('created_at',{ ascending:false })
      .limit(50);

    if(error){ console.warn('[LIST] error', error); $('#autolist').textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return; }

    const fmt = s => (s==null? '' : String(s));
    $('#autolist').innerHTML =
      (data&&data.length)
        ? data.map(t => `
            <div class="list-item">
              <div class="h">${fmt(t.title)||'(ç„¡é¡Œ)'}</div>
              <div style="color:#666;margin-top:4px;">${fmt(t.body)||''}</div>
              <div class="small">
                å„ªå…ˆåº¦:${fmt(t.priority)||'mid'}${t.due_at ? ' / æœŸæ—¥:' + new Date(t.due_at).toLocaleString() : ''}
              </div>
            </div>
          `).join('')
        : '<div class="muted">æœªè§£æ±ºã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    console.log('[LIST] rendered', data?.length||0);
  }catch(e){ console.error('[LIST] exception', e); }
};

// ---------- é€ä¿¡ï¼ˆDBä¿å­˜ â†’ ãƒªã‚¹ãƒˆæ›´æ–°ï¼‰ ----------
let sending = false;
$('#send').onclick = async () => {
  if(sending) return;
  sending = true; $('#send').disabled = true; setTimeout(()=>{$('#send').disabled=false; sending=false;},1500); // äºŒé‡é€ä¿¡é˜²æ­¢(1.5s)

  const row = {
    title: $('#title').value.trim(),
    body: $('#body').value.trim() || null,
    priority: 'mid',
    due_at: $('#due').value ? new Date($('#due').value).toISOString() : null,
    status: 'open', tags: [], project: null
  };
  showToast('ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ');

  try{
    if(!window.sb){ showToast('è¨­å®šæœªå®Œäº†'); return; }
    const { data, error } = await sb.from('tasks').insert(row).select();
    if(error){ console.warn('[insert error]', error); showToast('DBä¿å­˜ã‚¨ãƒ©ãƒ¼: '+error.message); }
    else { showToast('DBã«ä¿å­˜OK (id:'+(data?.[0]?.id ?? '?')+')'); if(window.__refresh_tasks__) window.__refresh_tasks__(); }
  }catch(e){ console.warn('[insert exception]', e); showToast('ä¾‹å¤–: '+e); }
};

// åˆæœŸæç”»
window.addEventListener('load', () => { refreshSessionLabel(); setTimeout(()=>window.__refresh_tasks__(), 250); });
</script>
</body>
</html>
