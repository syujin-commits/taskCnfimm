<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¢ºèªãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼šé€£ç¶šé€ä¿¡OKï¼‰</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --border:#e5e7eb; --text:#111827;
    --muted:#6b7280; --accent:#2563eb; --danger:#dc2626; --radius:14px;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;background:#fffcc;border-bottom:1px solid var(--border);
    background:rgba(255,255,255,.86);backdrop-filter: blur(8px);z-index:5}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  h1{margin:0;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .tabs{display:flex;gap:8px;margin-top:10px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);
    background:#fff;font-weight:700;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}
  .tab.disabled{opacity:.45;pointer-events:none}
  main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1 1 240px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);
    border-radius:12px;background:#fff}
  textarea{resize:vertical}
  .btn{padding:9px 12px;border-radius:10px;border:1px solid var(--border);
    background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);
    background:#f9fafb;font-size:12px}
  .hidden{display:none}
  .empty{border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center;color:var(--muted)}
  .grid .card{margin-bottom:12px}
  .flash{animation:flash 900ms ease-out 1}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(37,99,235,.35);background:#eff6ff}
                   100%{box-shadow:0 0 0 16px rgba(37,99,235,0);background:#ffffff}}
  /* welcome overlay */
  .welcome{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(rgba(255,255,255,.94),rgba(255,255,255,.94));z-index:20}
  .welcome.hidden{display:none}
  .welcome-card{background:#fff;border:1px solid var(--border);border-radius:16px;
    padding:20px;width:min(640px,92%);box-shadow:0 8px 40px rgba(0,0,0,.08)}
  .welcome-card h2{margin:0 0 6px}
  /* urgent overlay */
  .urgent{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(220,38,38,.14);backdrop-filter: blur(3px);z-index:15}
  .urgent.show{display:flex}
  .urgent-card{background:#fff;border:2px solid #fecaca;border-radius:18px;padding:18px;
    width:min(720px,92%);box-shadow:0 18px 60px rgba(220,38,38,.25)}
  .urgent-title{font-weight:800;font-size:18px;color:#991b1b;margin-bottom:8px}
  .toasts{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    display:flex;flex-direction:column;gap:8px;z-index:50}
  .toast{background:#111827;color:#fff;border-radius:12px;padding:10px 14px;opacity:.96}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ç¢ºèªãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>
      <div class="sub">å½¹å‰²ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¾é ¼ï¼‰ã€ã¨ã€Œå›šäººPï¼ˆæ‰¿èªï¼‰ã€ã§ã™ã€‚</div>
      <div class="tabs">
        <button id="tab-req" class="tab active" data-target="requester">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼ˆä¾é ¼ï¼‰</button>
        <button id="tab-app" class="tab" data-target="approver">å›šäººPç”¨ï¼ˆæ‰¿èªï¼‰</button>
      </div>
    </div>
  </header>

  <!-- login -->
  <div id="welcome" class="welcome">
    <div class="welcome-card">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³ã‚’é¸æŠ</h2>
      <p class="sub">å½¹å‰²ã‚’é¸ã‚“ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="row">
        <div class="grow">
          <label class="sub">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
          <select id="emp-select">
            <option>ãƒ¦ãƒ¼ã‚¶ãƒ¼A</option>
            <option>ãƒ¦ãƒ¼ã‚¶ãƒ¼B</option>
          </select>
        </div>
        <button id="login-emp" class="btn primary">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="login-boss" class="btn">å›šäººPã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
    </div>
  </div>

  <!-- urgent for approver -->
  <div id="urgent" class="urgent">
    <div class="urgent-card">
      <div class="urgent-title">âš  æ€¥ãã®ç¢ºèª</div>
      <div id="urgent-body"></div>
      <div style="text-align:right;margin-top:10px">
        <button id="urgent-go" class="btn primary">ä»Šã™ãç¢ºèªã™ã‚‹</button>
      </div>
    </div>
  </div>

  <main>
    <!-- requester panel -->
    <section id="panel-requester">
      <section class="card">
        <div class="row">
          <div class="grow">
            <label class="sub">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
            <select id="rq-template">
              <option value="">é¸æŠã—ãªã„</option>
              <option value="illust">ã‚¤ãƒ©ã‚¹ãƒˆç¢ºèª</option>
              <option value="talent">ã‚¿ãƒ¬ãƒ³ãƒˆè¿”ä¿¡ç¢ºèª</option>
              <option value="client">æ¡ˆä»¶å…ˆç¢ºèª</option>
              <option value="accounting">çµŒç†é–¢é€£</option>
            </select>
          </div>
          <div style="width:140px">
            <label class="sub">å„ªå…ˆåº¦</label>
            <select id="rq-priority">
              <option value="low">ä½</option>
              <option value="mid" selected>ä¸­</option>
              <option value="high">é«˜</option>
            </select>
          </div>
          <div style="width:220px">
            <label class="sub">æœŸé™</label>
            <input type="datetime-local" id="rq-due" />
          </div>
          <div>
            <label class="sub">&nbsp;</label>
            <button id="rq-send" class="btn primary">é€ä¿¡</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="grow"><input id="rq-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" /></div>
          <div style="width:260px"><input id="rq-tags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰" /></div>
          <div style="width:200px"><input id="rq-project" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆä»»æ„ï¼‰" /></div>
        </div>
        <div class="row" style="margin-top:10px"><textarea id="rq-body" rows="4" placeholder="è©³ç´°"></textarea></div>
      </section>

      <section class="card">
        <div style="font-weight:700;margin-bottom:6px">ã‚ãªãŸã®æœªè§£æ±ºã‚¿ã‚¹ã‚¯</div>
        <div id="rq-open" class="grid"></div>
        <div id="rq-open-empty" class="empty">æœªè§£æ±ºã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>
      </section>

      <section class="card">
        <div style="font-weight:700;margin-bottom:6px">å›šäººPç¢ºèªæ¸ˆï¼ˆå±¥æ­´ï¼‰</div>
        <div id="rq-done" class="grid"></div>
        <div id="rq-done-empty" class="empty">ç¢ºèªæ¸ˆã¿ã®ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
      </section>
    </section>

    <!-- approver panel -->
    <section id="panel-approver" class="hidden">
      <section class="card">
        <div style="font-weight:700;margin-bottom:6px">æœªè§£æ±º</div>
        <div id="ap-open" class="grid"></div>
        <div id="ap-open-empty" class="empty">ã‚ã‚Šã¾ã›ã‚“</div>
        <div style="font-weight:700;margin:14px 0 6px">å®Œäº†æ¸ˆã¿</div>
        <div id="ap-done" class="grid"></div>
        <div id="ap-done-empty" class="empty">ã‚ã‚Šã¾ã›ã‚“</div>
      </section>
    </section>
  </main>

  <div id="toasts" class="toasts"></div>

<script>
  // ===== State & helpers =====
  const state = {
    tasks: [], nextId: 1,
    currentUser: null, // {role:'requester'|'approver', name:string}
  };
  const $ = sel => document.querySelector(sel);
  const html = s => String(s ?? '').replace(/[&<>]/g, ch => ch==='&'?'&amp;':(ch==='<'?'&lt;':'&gt;'));
  function showToast(msg){ const box=$('#toasts'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity=.0; setTimeout(()=>t.remove(),260)},1600); }

  // ===== Login =====
  $('#login-emp').addEventListener('click', ()=>{ state.currentUser={role:'requester',name:$('#emp-select').value}; $('#welcome').classList.add('hidden'); showPanel('requester'); renderAll(); });
  $('#login-boss').addEventListener('click', ()=>{ state.currentUser={role:'approver',name:'å›šäººP'}; $('#welcome').classList.add('hidden'); showPanel('approver'); renderAll(); });

  // ===== Tabs =====
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=>{
    if(!state.currentUser){ alert('å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    const target = b.dataset.target;
    if(state.currentUser.role==='requester' && target==='approver'){ alert('å›šäººPã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™'); return; }
    if(state.currentUser.role==='approver' && target==='requester'){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™'); return; }
    showPanel(target);
  }));
  function showPanel(which){
    $('#tab-req').classList.toggle('active', which==='requester');
    $('#tab-app').classList.toggle('active', which==='approver');
    $('#panel-requester').classList.toggle('hidden', which!=='requester');
    $('#panel-approver').classList.toggle('hidden', which!=='approver');
  }

  // ===== Templates =====
  $('#rq-template').addEventListener('change', e=>{
    const v = e.target.value;
    if(v==='illust'){
      $('#rq-title').value='ã‚¤ãƒ©ã‚¹ãƒˆç¢ºèª';
      $('#rq-body').value='ã‚¤ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®ç´ æï¼ä¿®æ­£æ¡ˆã®ç¢ºèªã§ã™ã€‚å•é¡Œãªã‘ã‚Œã°OKã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚';
      $('#rq-tags').value='ã‚¤ãƒ©ã‚¹ãƒˆ,ç¢ºèª';
    } else if(v==='talent'){
      $('#rq-title').value='ã‚¿ãƒ¬ãƒ³ãƒˆè¿”ä¿¡ç¢ºèª';
      $('#rq-body').value='ã‚¿ãƒ¬ãƒ³ãƒˆã‹ã‚‰ã®è¦æœ›ï¼è¿”ä¿¡å†…å®¹ã«ã¤ã„ã¦ã”ç¢ºèªãã ã•ã„ã€‚';
      $('#rq-tags').value='ã‚¿ãƒ¬ãƒ³ãƒˆ,è¿”ä¿¡';
    } else if(v==='client'){
      $('#rq-title').value='æ¡ˆä»¶å…ˆç¢ºèª';
      $('#rq-body').value='æ¡ˆä»¶å…ˆã¨ã®ã‚„ã‚Šå–ã‚Šï¼ˆæ–‡é¢ãƒ»æ¡ä»¶ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ã«é–¢ã™ã‚‹ç¢ºèªã§ã™ã€‚';
      $('#rq-tags').value='æ¡ˆä»¶å…ˆ,ç¢ºèª';
    } else if(v==='accounting'){
      $('#rq-title').value='çµŒç†é–¢é€£';
      $('#rq-body').value='çµŒç†ãƒ»è«‹æ±‚æ›¸ãƒ»æ”¯æ‰•ã„é–¢é€£ã®ç¢ºèªã§ã™ã€‚';
      $('#rq-tags').value='çµŒç†,è«‹æ±‚';
    }
  });

  // ===== Send (é€£ç¶šé€ä¿¡OKãƒ»ãƒœã‚¿ãƒ³ç„¡å¤‰æ›´ãƒ»å³åæ˜ ) =====
  $('#rq-send').addEventListener('click', () => {
    if(!state.currentUser || state.currentUser.role!=='requester'){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
    const row = {
      id: state.nextId++,
      title: $('#rq-title').value.trim(),
      body: $('#rq-body').value.trim(),
      priority: $('#rq-priority').value,
      due_at: $('#rq-due').value ? new Date($('#rq-due').value).toISOString(): null,
      status: 'open',
      created_by_name: state.currentUser.name,
      archived_for: [], nudge_count:0, last_nudged_at:null,
      tags: $('#rq-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      project: $('#rq-project').value.trim()||null,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    };
    if(!row.title){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆ'); return; }

    // è¿½åŠ â†’å³æç”»
    state.tasks.unshift(row);
    renderAll();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ˆæ¬¡ã®å…¥åŠ›ã¸ï¼‰
    $('#rq-title').value=''; $('#rq-body').value=''; $('#rq-priority').value='mid';
    $('#rq-due').value=''; $('#rq-tags').value=''; $('#rq-project').value=''; $('#rq-template').value='';

    // æœªè§£æ±ºã®æ–°ã‚«ãƒ¼ãƒ‰ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    requestAnimationFrame(()=>{
      const el = document.querySelector(`#rq-open .card[data-id="${row.id}"]`);
      if(el){ el.scrollIntoView({behavior:'smooth', block:'nearest'}); el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'),850); }
    });

    showToast('ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
  });

  // ===== Renderers =====
  function renderAll(){ renderRequester(); renderApprover(); updateUrgent(); }

  function renderRequester(){
    if(!state.currentUser || state.currentUser.role!=='requester'){ return; }
    const who = state.currentUser.name;
    const open = state.tasks.filter(t=> t.created_by_name===who && t.status!=='confirmed');
    const done = state.tasks.filter(t=> t.created_by_name===who && t.status==='confirmed' && !(t.archived_for||[]).includes(who));

    // open
    $('#rq-open').innerHTML='';
    $('#rq-open-empty').classList.toggle('hidden', open.length>0);
    open.forEach(t=> $('#rq-open').appendChild(cardRequesterOpen(t)));

    // done
    $('#rq-done').innerHTML='';
    $('#rq-done-empty').classList.toggle('hidden', done.length>0);
    done.forEach(t=> $('#rq-done').appendChild(cardRequesterDone(t, who)));
  }

  function cardRequesterOpen(t){
    const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.id=t.id;
    const due = t.due_at? `<span class="pill">æœŸé™: ${new Date(t.due_at).toLocaleString()}</span>`:'';
    wrap.innerHTML = `
      <div style="font-weight:700">${html(t.title)}</div>
      <div class="row">
        <span class="pill">å„ªå…ˆåº¦: ${t.priority}</span>
        ${due}
        ${t.project? `<span class="pill">PJ: ${html(t.project)}</span>`:''}
        <span class="pill">çŠ¶æ…‹: ${html(t.status)}</span>
      </div>
      ${t.body? `<div style="margin-top:8px">${html(t.body)}</div>`:''}
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button class="btn primary" data-act="hurry">æ€¥ã’ï¼ˆé€šçŸ¥ï¼‰</button>
        <span class="pill">æ€¥ãé€ä¿¡ ${t.nudge_count||0}å›</span>
      </div>
    `;
    wrap.querySelector('[data-act="hurry"]').addEventListener('click', ()=>{ t.nudge_count=(t.nudge_count||0)+1; t.last_nudged_at=new Date().toISOString(); showToast('å›šäººPã¸æ€¥ãé€šçŸ¥ã‚’é€ä¿¡'); renderAll(); });
    return wrap;
  }

  function cardRequesterDone(t, who){
    const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.id=t.id;
    wrap.innerHTML = `
      <div style="font-weight:700">${html(t.title)}</div>
      <div class="row">
        ${t.project? `<span class="pill">PJ: ${html(t.project)}</span>`:''}
        <span class="pill">çŠ¶æ…‹: ç¢ºèªæ¸ˆã¿</span>
      </div>
      ${t.body? `<div style="margin-top:8px">${html(t.body)}</div>`:''}
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn danger" data-act="archive">è‡ªåˆ†ã®å±¥æ­´ã‹ã‚‰æ¶ˆã™</button>
      </div>
    `;
    wrap.querySelector('[data-act="archive"]').addEventListener('click', ()=>{
      const arr=t.archived_for||(t.archived_for=[]); if(!arr.includes(who)) arr.push(who);
      animateRemove(wrap); setTimeout(()=>renderAll(),240);
      showToast('å±¥æ­´ã‹ã‚‰æ¶ˆã—ã¾ã—ãŸï¼ˆã‚ãªãŸã®ç”»é¢ã®ã¿ï¼‰');
    });
    return wrap;
  }

  function renderApprover(){
    if(!state.currentUser || state.currentUser.role!=='approver'){ return; }
    const open = state.tasks.filter(t=> t.status!=='confirmed');
    const done = state.tasks.filter(t=> t.status==='confirmed');

    // open
    $('#ap-open').innerHTML='';
    $('#ap-open-empty').classList.toggle('hidden', open.length>0);
    open.forEach(t=> $('#ap-open').appendChild(cardApproverOpen(t)));

    // done
    $('#ap-done').innerHTML='';
    $('#ap-done-empty').classList.toggle('hidden', done.length>0);
    done.forEach(t=> $('#ap-done').appendChild(cardApproverDone(t)));
  }

  function cardApproverOpen(t){
    const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.id=t.id;
    const due = t.due_at? `<span class="pill">æœŸé™: ${new Date(t.due_at).toLocaleString()}</span>`:'';
    wrap.innerHTML = `
      <div style="font-weight:700">${html(t.title)}</div>
      <div class="row">
        <span class="pill">ä¾é ¼: ${html(t.created_by_name)}</span>
        <span class="pill">å„ªå…ˆåº¦: ${t.priority}</span>
        ${due}
        ${t.project? `<span class="pill">PJ: ${html(t.project)}</span>`:''}
      </div>
      ${t.body? `<div style="margin-top:8px">${html(t.body)}</div>`:''}
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="btn primary" data-act="ok">ç¢ºèªæ¸ˆã¿</button>
      </div>
    `;
    wrap.querySelector('[data-act="ok"]').addEventListener('click', ()=>{ t.status='confirmed'; t.updated_at=new Date().toISOString(); renderAll(); });
    return wrap;
  }
  function cardApproverDone(t){
    const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.id=t.id;
    wrap.innerHTML = `
      <div style="font-weight:700">${html(t.title)}</div>
      <div class="row">
        <span class="pill">ä¾é ¼: ${html(t.created_by_name)}</span>
        <span class="pill">çŠ¶æ…‹: ç¢ºèªæ¸ˆã¿</span>
      </div>
      ${t.body? `<div style="margin-top:8px">${html(t.body)}</div>`:''}
    `;
    return wrap;
  }

  // ===== Urgent overlay =====
  function updateUrgent(){
    const box = $('#urgent'); if(!state.currentUser || state.currentUser.role!=='approver'){ box.classList.remove('show'); return; }
    const urg = state.tasks.filter(t=> (t.nudge_count||0)>0 && t.status!=='confirmed').sort((a,b)=> new Date(b.last_nudged_at||0)-new Date(a.last_nudged_at||0));
    if(!urg.length){ box.classList.remove('show'); return; }
    const t = urg[0]; $('#urgent-body').innerHTML = `<div style="font-weight:700">${html(t.title)}</div><div class="pill">ä¾é ¼: ${html(t.created_by_name)}</div>`;
    box.classList.add('show');
    $('#urgent-go').onclick = ()=>{
      showPanel('approver');
      setTimeout(()=>{
        const el = document.querySelector(`#ap-open .card[data-id="${t.id}"]`);
        if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('flash'); setTimeout(()=>el.classList.remove('flash'),850); }
      },40);
    };
  }

  function animateRemove(el){
    const h=el.getBoundingClientRect().height;
    el.style.height=h+'px'; el.style.transition='height .22s ease, opacity .15s ease, transform .18s ease'; el.style.overflow='hidden';
    requestAnimationFrame(()=>{ el.style.opacity='0'; el.style.transform='scale(.98)'; el.style.height='0px'; });
    setTimeout(()=> el.remove(), 230);
  }
</script>

<!-- Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Confirm Tasks: èªè¨¼ & åˆæœŸè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆv3 æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ä»˜ãï¼‰ -->
<script>
(()=>{
  const LS_URL = 'ct_sb_url';
  const LS_KEY = 'ct_sb_anon';
  const APPROVER_EMAILS = ["producer@example.com"]; // å›šäººPã«ã—ãŸã„ãƒ¡ãƒ¼ãƒ«

  // ===== ã‚¹ã‚¿ã‚¤ãƒ« =====
  const css = `
    #welcome { display:none !important; } /* æ—§ãƒ€ãƒŸãƒ¼éè¡¨ç¤º */
    .ct_overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .ct_card{background:#fff;min-width:320px;max-width:420px;padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .ct_card h3{margin:0 0 8px;font-size:18px}
    .ct_card label{font-size:12px;color:#555}
    .ct_card input{width:100%;margin:4px 0 8px;padding:10px 12px;border:1px solid #ddd;border-radius:8px}
    .ct_row{display:flex;gap:8px;margin-top:8px}
    .ct_row button{flex:1;padding:10px 12px;border:0;border-radius:8px;cursor:pointer}
    .ct_primary{background:#111;color:#fff}
    .ct_ghost{background:#eee}
    .ct_msg{min-height:18px;font-size:12px;color:#d00;margin-top:6px}
    #ct_btn_logout{position:fixed;top:12px;right:12px;z-index:9999;padding:8px 10px;border:0;border-radius:8px;background:#eee;display:none}
    #ct_btn_settings{position:fixed;top:12px;left:12px;z-index:9999;padding:8px 10px;border:0;border-radius:8px;background:#eee}
    #ct_btn_login{position:fixed;top:12px;left:92px;z-index:9999;padding:8px 10px;border:0;border-radius:8px;background:#eee}
    #ct_status{position:fixed;top:12px;left:180px;z-index:9999;padding:8px 10px;background:#f6f6f6;border-radius:8px;font-size:12px;color:#333}
  `;
  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  // ===== ç”»é¢ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³é¡ =====
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«stateã¸ã®å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ï¼ˆconst state ã¯ windowã«ä¹—ã‚‰ãªã„å¯¾ç­–ï¼‰
  function setCurrentUserSafe(user){
    try {
      if (typeof state !== 'undefined' && state && typeof state === 'object') {
        state.currentUser = user;
      } else if (globalThis && globalThis.state) {
        globalThis.state.currentUser = user;
      }
    } catch (e) { /* noop */ }
  }
const btnSettings = document.createElement('button');
  btnSettings.id='ct_btn_settings'; btnSettings.textContent='âš™ è¨­å®š';
  const btnLogin = document.createElement('button');
  btnLogin.id='ct_btn_login'; btnLogin.textContent='ğŸ” ãƒ­ã‚°ã‚¤ãƒ³';
  const btnLogout = document.createElement('button');
  btnLogout.id='ct_btn_logout'; btnLogout.textContent='â ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
  const status = document.createElement('div');
  status.id='ct_status'; status.textContent='æœªãƒ­ã‚°ã‚¤ãƒ³';
  document.body.appendChild(btnSettings);
  document.body.appendChild(btnLogin);
  document.body.appendChild(btnLogout);
  document.body.appendChild(status);

  // ===== è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° =====
  const ovSetup = document.createElement('div');
  ovSetup.className='ct_overlay'; ovSetup.id='ct_setup_ov';
  ovSetup.innerHTML = `
    <div class="ct_card">
      <h3>åˆæœŸè¨­å®šï¼ˆSupabaseï¼‰</h3>
      <label>Project URL</label>
      <input id="ct_url" type="text" placeholder="https://xxxx.supabase.co" />
      <label>anon public key</label>
      <input id="ct_key" type="text" placeholder="eyJ..." />
      <div class="ct_row">
        <button id="ct_save" class="ct_primary">ä¿å­˜ã—ã¦å†èª­ã¿è¾¼ã¿</button>
        <button id="ct_clear" class="ct_ghost">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="ct_msg" id="ct_setup_msg"></div>
    </div>
  `;
  document.body.appendChild(ovSetup);

  // ===== ãƒ­ã‚°ã‚¤ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚° =====
  const ovAuth = document.createElement('div');
  ovAuth.className='ct_overlay'; ovAuth.id='ct_auth_ov';
  ovAuth.innerHTML = `
    <div class="ct_card">
      <h3>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</h3>
      <label>ãƒ¡ãƒ¼ãƒ«</label>
      <input id="ct_auth_email" type="email" placeholder="you@example.com" autocomplete="email" />
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input id="ct_auth_pass" type="password" placeholder="â—â—â—â—â—â—" autocomplete="current-password" />
      <div class="ct_row">
        <button id="ct_login" class="ct_primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="ct_signup" class="ct_ghost">æ–°è¦ç™»éŒ²</button>
      </div>
      <div class="ct_msg" id="ct_auth_msg"></div>
    </div>
  `;
  document.body.appendChild(ovAuth);

  const $ = (id)=>document.getElementById(id);
  const show = (el)=>{ el.style.display='flex'; };
  const hide = (el)=>{ el.style.display='none'; };
  const msg = (t,c='#d00')=>{ const m=$('ct_auth_msg'); m.style.color=c; m.textContent=t||''; };

  const env = {
    url: localStorage.getItem(LS_URL) || '',
    key: localStorage.getItem(LS_KEY) || ''
  };
  function refreshStatus(user){
    if(!user){ status.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³'; return; }
    status.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š' + (user.email || user.id);
  }

  // è¨­å®šUIã‚¤ãƒ™ãƒ³ãƒˆ
  btnSettings.onclick = () => {
    $('ct_url').value = env.url;
    $('ct_key').value = env.key;
    $('ct_setup_msg').textContent='';
    show(ovSetup);
  };
  $('ct_clear').onclick = () => {
    localStorage.removeItem(LS_URL);
    localStorage.removeItem(LS_KEY);
    $('ct_setup_msg').style.color = '#0a0';
    $('ct_setup_msg').textContent = 'ä¿å­˜æ¸ˆã¿ã®URL/KEYã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚';
    $('ct_url').value = '';
    $('ct_key').value = '';
  };
  $('ct_save').onclick = () => {
    const url = $('ct_url').value.trim();
    const key = $('ct_key').value.trim();
    if(!url || !key){ $('ct_setup_msg').textContent='URLã¨KEYã‚’ä¸¡æ–¹å…¥ã‚Œã¦ãã ã•ã„ã€‚'; return; }
    localStorage.setItem(LS_URL, url);
    localStorage.setItem(LS_KEY, key);
    location.reload();
  };

  // å¿…é ˆè¨­å®šãŒãªã‘ã‚Œã°è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™
  if(!env.url || !env.key){ show(ovSetup); }

  // ===== Supabase åˆæœŸåŒ–ï¼ˆè¨­å®šæ¸ˆã¿ã®ã¨ãã ã‘ï¼‰ =====
  let sb = null;
  if(env.url && env.key){
    if(!window.supabase){ alert('supabase-js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    sb = window.supabase.createClient(env.url, env.key);

    
async function afterLogin(){
      const { data:{ user } } = await sb.auth.getUser();
      refreshStatus(user);
      if(!user){ show(ovAuth); btnLogout.style.display='none'; return; }

      // --- profiles èª­ã¿ or ä½œæˆï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§requesterã«ã™ã‚‹ï¼‰ ---
      let prof = null;
      try {
        const sel = await sb.from('profiles').select('id,name,role').eq('id', user.id).maybeSingle();
        if (sel.error) throw sel.error;
        prof = sel.data;
        if (!prof) {
          const defaultName = (user.email||'user').split('@')[0];
          const ins = await sb.from('profiles').insert({ id:user.id, name:defaultName, role:'requester' }).select().single();
          if (ins.error) throw ins.error;
          prof = ins.data;
        }
        // ãƒ¡ãƒ¼ãƒ«ä¸€è‡´ã§ approver ã«æ˜‡æ ¼
        const wantApprover = APPROVER_EMAILS.map(e=>e.toLowerCase()).includes((user.email||'').toLowerCase());
        if (wantApprover && prof.role!=='approver'){
          const up = await sb.from('profiles').update({ role:'approver', name:'å›šäººP' }).eq('id', user.id).select().single();
          if (!up.error) prof = up.data;
        }
      } catch(e){
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        prof = { id: user.id, name: (user.email||'user').split('@')[0], role: 'requester' };
      }

      // æ—¢å­˜UIã«åæ˜ 
      setCurrentUserSafe({ id: prof.id, name: prof.name, role: prof.role });
      if(window.showPanel) window.showPanel(prof.role==='approver' ? 'approver' : 'requester');
      if(window.renderAll) window.renderAll();
      if(window.updateUrgent) window.updateUrgent();
      if(window.showToast) window.showToast('ãƒ­ã‚°ã‚¤ãƒ³ï¼š'+prof.name+'ï¼ˆ'+prof.role+'ï¼‰');

      hide(ovAuth);
      btnLogout.style.display='block';
    }


    // ã‚¤ãƒ™ãƒ³ãƒˆ
    $('ct_login').onclick = async ()=>{
      msg('');
      const email = $('ct_auth_email').value.trim();
      const password = $('ct_auth_pass').value;
      if(!email || !password){ msg('ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ msg('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: '+error.message); return; }
      afterLogin();
    };
    $('ct_signup').onclick = async ()=>{
      msg('');
      const email = $('ct_auth_email').value.trim();
      const password = $('ct_auth_pass').value;
      if(!email || !password){ msg('ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„'); return; }
      const { error } = await sb.auth.signUp({ email, password });
      if(error){ msg('ç™»éŒ²å¤±æ•—: '+error.message); return; }
      msg('ç™»éŒ²OKã€‚ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªè¨­å®šã®å ´åˆã¯å—ä¿¡ç®±ã‚’ãƒã‚§ãƒƒã‚¯ã€‚', '#0a0');
    };

    btnLogin.onclick = ()=>{ show(ovAuth); }; // æ‰‹å‹•ã§ã„ã¤ã§ã‚‚å‡ºã›ã‚‹
    btnLogout.onclick = async ()=>{
      await sb.auth.signOut();
      setCurrentUserSafe(null);
      show(ovAuth);
      btnLogout.style.display='none';
      refreshStatus(null);
      if(window.showToast) window.showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
    };

    // èµ·å‹•æ™‚ï¼šçŠ¶æ…‹å¾©å…ƒï¼ˆè¦‹ãˆãªãã¦ã‚‚æ‰‹å‹•ãƒœã‚¿ãƒ³ã‹ã‚‰å‡ºã›ã‚‹ï¼‰
    sb.auth.getSession().then(({ data:{ session } })=>{
      if(session){ afterLogin(); } else { refreshStatus(null); }
    });
  }
})();
</script>


<!-- === Supabase DB é€£æºï¼ˆTasks CRUD + Realtimeï¼‰ / production bridge === -->
<script>
(()=>{
  const LS_URL = 'ct_sb_url';
  const LS_KEY = 'ct_sb_anon';

  function getClient(){
    const url = localStorage.getItem(LS_URL);
    const key = localStorage.getItem(LS_KEY);
    if(!url || !key || !window.supabase) return null;
    return window.supabase.createClient(url, key);
  }
  const sb = getClient();
  if(!sb){ console.warn('[DB Bridge] Supabase client not ready.'); return; }

  // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒãƒ—ï¼ˆè¡¨ç¤ºåã«ä½¿ç”¨ï¼‰
  async function fetchNameMap(ids){
    const uniq = Array.from(new Set(ids.filter(Boolean)));
    if(!uniq.length) return {};
    const { data, error } = await sb.from('profiles').select('id,name').in('id', uniq);
    if(error){ console.warn('[DB] profiles map error', error); return {}; }
    const map = {}; uniq.forEach(id=> map[id] = id.slice(0,8));
    data?.forEach(r=> map[r.id] = r.name || r.id.slice(0,8));
    return map;
  }

  function toUiTask(row, nameMap){
    return {
      id: row.id,
      title: row.title, body: row.body||'',
      status: row.status, priority: row.priority,
      due_at: row.due_at,
      created_by_name: nameMap[row.created_by] || 'unknown',
      archived_for: (row.archived_by||[]).map(uid=> nameMap[uid] || uid.slice(0,8)),
      nudge_count: row.nudge_count||0,
      last_nudged_at: row.last_nudged_at,
      project: row.project||'',
      tags: row.tags||[],
      created_at: row.created_at, updated_at: row.updated_at,
    };
  }

  async function refreshTasks(){
    if(!window.state || !window.state.currentUser) return;
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ return; }
    const { data: rows, error } = await sb
      .from('tasks')
      .select('id,title,body,status,priority,due_at,created_by,archived_by,nudge_count,last_nudged_at,project,tags,created_at,updated_at')
      .order('created_at', { ascending:false });
    if(error){ console.warn('[DB] fetch tasks error', error); return; }
    const ids = [
      ...rows.map(r=>r.created_by),
      ...rows.flatMap(r=> (r.archived_by||[]))
    ];
    const nameMap = await fetchNameMap(ids);
    window.state.tasks = rows.map(r=> toUiTask(r, nameMap));
    if(window.renderAll) window.renderAll();
    if(window.updateUrgent) window.updateUrgent();
  }

  function hookSend(){
    const btn = document.getElementById('rq-send');
    if(!btn || btn.__dbHooked) return;
    const clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.__dbHooked = true;
    clone.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!window.state?.currentUser || window.state.currentUser.role!=='requester'){
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return;
      }
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ alert('æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™'); return; }
      const dueVal = document.getElementById('rq-due').value;
      const tags = document.getElementById('rq-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      const payload = {
        title: document.getElementById('rq-title').value.trim(),
        body: document.getElementById('rq-body').value.trim() || null,
        priority: document.getElementById('rq-priority').value || 'mid',
        due_at: dueVal ? new Date(dueVal).toISOString() : null,
        created_by: user.id,
        status: 'open',
        project: document.getElementById('rq-project').value.trim() || null,
        tags
      };
      if(!payload.title){ alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆ'); return; }
      const { error } = await sb.from('tasks').insert(payload);
      if(error){ alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: '+error.message); return; }
      if(window.showToast) window.showToast('DBã«ä¿å­˜ã—ã¾ã—ãŸ');
      document.getElementById('rq-title').value='';
      document.getElementById('rq-body').value='';
      document.getElementById('rq-priority').value='mid';
      document.getElementById('rq-due').value='';
      document.getElementById('rq-tags').value='';
      document.getElementById('rq-project').value='';
      document.getElementById('rq-template').value='';
      await refreshTasks();
    });
  }

  async function onClickGlobal(e){
    const el = e.target.closest('[data-act]'); if(!el) return;
    const card = e.target.closest('.card'); if(!card) return;
    const id = Number(card.dataset.id);
    const act = el.getAttribute('data-act');
    const { data:{ user } } = await sb.auth.getUser();
    if(!user) return;

    const { data: rows } = await sb.from('tasks').select('id,archived_by,nudge_count').eq('id', id).limit(1);
    const cur = rows && rows[0];

    if(act==='ok'){ // æ‰¿èª
      await sb.from('tasks').update({ status:'confirmed' }).eq('id', id);
      await refreshTasks();
    }
    if(act==='archive'){ // è‡ªåˆ†ã®å±¥æ­´ã‹ã‚‰æ¶ˆã™
      const arr = Array.from(new Set([...(cur?.archived_by||[]), user.id]));
      await sb.from('tasks').update({ archived_by: arr }).eq('id', id);
      await refreshTasks();
    }
    if(act==='hurry'){ // æ€¥ã’
      const n = (cur?.nudge_count || 0) + 1;
      await sb.from('tasks').update({ nudge_count: n, last_nudged_at: new Date().toISOString() }).eq('id', id);
      await refreshTasks();
    }
  }
  document.addEventListener('click', onClickGlobal, true);

  // Realtimeè³¼èª­ï¼ˆINSERT/UPDATEï¼‰
  const ch = sb.channel('tasks-db-sync')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'tasks' }, refreshTasks)
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tasks' }, refreshTasks)
    .subscribe();

  async function initWhenReady(){
    for(let i=0;i<40;i++){
      if(window.state?.currentUser){ break; }
      await new Promise(r=> setTimeout(r, 250));
    }
    hookSend();
    await refreshTasks();
  }
  initWhenReady();
  const obs = new MutationObserver(()=> hookSend());
  obs.observe(document.body, { childList:true, subtree:true });
})();
</script>

</body>
</html>
